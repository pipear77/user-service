<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegistrarUsuarioUseCase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">usecase</a> &gt; <a href="index.source.html" class="el_package">co.com.pragma.usecase.registrarusuario</a> &gt; <span class="el_source">RegistrarUsuarioUseCase.java</span></div><h1>RegistrarUsuarioUseCase.java</h1><pre class="source lang-java linenums">package co.com.pragma.usecase.registrarusuario;
import co.com.pragma.model.usuario.gateways.JwtProviderRepository;
import lombok.Getter;
import reactor.core.publisher.Mono;

import co.com.pragma.model.usuario.Usuario;
import co.com.pragma.model.usuario.gateways.UsuarioRepository;
import co.com.pragma.model.usuario.gateways.PasswordEncoderRepository;
import co.com.pragma.usecase.common.UsuarioValidationPipeline;
import co.com.pragma.usecase.common.validacion.fields.*;
import co.com.pragma.usecase.exceptions.CorreoYaRegistradoException;
import lombok.RequiredArgsConstructor;
import reactor.core.publisher.Flux;

import java.util.UUID;

import static co.com.pragma.usecase.common.ConstantesUsuario.ERROR_CORREO_DUPLICADO;

@Getter
@RequiredArgsConstructor
public class RegistrarUsuarioUseCase implements RegistrarUsuarioUseCaseInterface {

    private final UsuarioRepository usuarioRepository;
    private final PasswordEncoderRepository passwordEncoderRepository;
    private final JwtProviderRepository jwtProvider;

    @Override
    public Mono&lt;Usuario&gt; save(Usuario usuario) {
<span class="fc" id="L29">        UsuarioValidationPipeline pipeline = new UsuarioValidationPipeline()</span>
<span class="fc" id="L30">                .agregarValidacion(new Nombre())</span>
<span class="fc" id="L31">                .agregarValidacion(new Apellido())</span>
<span class="fc" id="L32">                .agregarValidacion(new NumeroDocumento())</span>
<span class="fc" id="L33">                .agregarValidacion(new CorreoElectronico())</span>
<span class="fc" id="L34">                .agregarValidacion(new Salario());</span>

<span class="fc" id="L36">        return pipeline.validar(usuario)</span>
<span class="fc" id="L37">                .then(usuarioRepository.existsByEmail(usuario.getCorreoElectronico()))</span>
<span class="fc" id="L38">                .flatMap(existe -&gt; {</span>
<span class="fc bfc" id="L39" title="All 2 branches covered.">                    if (existe) {</span>
<span class="fc" id="L40">                        return Mono.error(new CorreoYaRegistradoException(ERROR_CORREO_DUPLICADO + usuario.getCorreoElectronico()));</span>
                    }
<span class="fc" id="L42">                    return Mono.just(usuario)</span>
<span class="fc" id="L43">                            .flatMap(u -&gt; {</span>
<span class="fc" id="L44">                                Usuario nuevoUsuario = u.toBuilder()</span>
<span class="fc" id="L45">                                        .contrasena(passwordEncoderRepository.encode(u.getContrasena()))</span>
<span class="fc" id="L46">                                        .build();</span>
<span class="fc" id="L47">                                return usuarioRepository.save(nuevoUsuario);</span>
                            });

                });
    }

    @Override
    public Flux&lt;Usuario&gt; getAllUsuarios() {
<span class="nc" id="L55">        return usuarioRepository.findAllUsuarios();</span>
    }

    @Override
    public Mono&lt;Boolean&gt; existsByEmail(String email) {
<span class="fc" id="L60">        return usuarioRepository.existsByEmail(email);</span>
    }

    @Override
    public Mono&lt;Boolean&gt; existsByDocumentNumber(String documentNumber) {
<span class="nc" id="L65">        return usuarioRepository.existsByDocumentNumber(documentNumber);</span>
    }

    @Override
    public Mono&lt;Usuario&gt; getUsuarioPorDocumento(String documentoIdentidad) {
<span class="nc" id="L70">        return usuarioRepository.findByNumeroDocumento(documentoIdentidad);</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>